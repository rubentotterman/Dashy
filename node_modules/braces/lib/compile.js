'use strict';

const fill = require('fill-range');
const utils = require('./utils');

const compile = (ast, options = {}) => {
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> fde19de (Supabase initialization)
  const walk = (node, parent = {}) => {
    const invalidBlock = utils.isInvalidBrace(parent);
    const invalidNode = node.invalid === true && options.escapeInvalid === true;
    const invalid = invalidBlock === true || invalidNode === true;
    const prefix = options.escapeInvalid === true ? '\\' : '';
<<<<<<< HEAD
=======
  let walk = (node, parent = {}) => {
    let invalidBlock = utils.isInvalidBrace(parent);
    let invalidNode = node.invalid === true && options.escapeInvalid === true;
    let invalid = invalidBlock === true || invalidNode === true;
    let prefix = options.escapeInvalid === true ? '\\' : '';
>>>>>>> b442312 (Initial commit)
=======
>>>>>>> fde19de (Supabase initialization)
    let output = '';

    if (node.isOpen === true) {
      return prefix + node.value;
    }
<<<<<<< HEAD
<<<<<<< HEAD

    if (node.isClose === true) {
      console.log('node.isClose', prefix, node.value);
=======
    if (node.isClose === true) {
>>>>>>> b442312 (Initial commit)
=======

    if (node.isClose === true) {
      console.log('node.isClose', prefix, node.value);
>>>>>>> fde19de (Supabase initialization)
      return prefix + node.value;
    }

    if (node.type === 'open') {
<<<<<<< HEAD
<<<<<<< HEAD
      return invalid ? prefix + node.value : '(';
    }

    if (node.type === 'close') {
      return invalid ? prefix + node.value : ')';
    }

    if (node.type === 'comma') {
      return node.prev.type === 'comma' ? '' : invalid ? node.value : '|';
=======
      return invalid ? (prefix + node.value) : '(';
=======
      return invalid ? prefix + node.value : '(';
>>>>>>> fde19de (Supabase initialization)
    }

    if (node.type === 'close') {
      return invalid ? prefix + node.value : ')';
    }

    if (node.type === 'comma') {
<<<<<<< HEAD
      return node.prev.type === 'comma' ? '' : (invalid ? node.value : '|');
>>>>>>> b442312 (Initial commit)
=======
      return node.prev.type === 'comma' ? '' : invalid ? node.value : '|';
>>>>>>> fde19de (Supabase initialization)
    }

    if (node.value) {
      return node.value;
    }

    if (node.nodes && node.ranges > 0) {
<<<<<<< HEAD
<<<<<<< HEAD
      const args = utils.reduce(node.nodes);
      const range = fill(...args, { ...options, wrap: false, toRegex: true, strictZeros: true });
=======
      let args = utils.reduce(node.nodes);
      let range = fill(...args, { ...options, wrap: false, toRegex: true });
>>>>>>> b442312 (Initial commit)
=======
      const args = utils.reduce(node.nodes);
      const range = fill(...args, { ...options, wrap: false, toRegex: true, strictZeros: true });
>>>>>>> fde19de (Supabase initialization)

      if (range.length !== 0) {
        return args.length > 1 && range.length > 1 ? `(${range})` : range;
      }
    }

    if (node.nodes) {
<<<<<<< HEAD
<<<<<<< HEAD
      for (const child of node.nodes) {
        output += walk(child, node);
      }
    }

=======
      for (let child of node.nodes) {
        output += walk(child, node);
      }
    }
>>>>>>> b442312 (Initial commit)
=======
      for (const child of node.nodes) {
        output += walk(child, node);
      }
    }

>>>>>>> fde19de (Supabase initialization)
    return output;
  };

  return walk(ast);
};

module.exports = compile;
